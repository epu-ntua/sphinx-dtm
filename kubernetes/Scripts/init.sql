DROP STREAM IF EXISTS RCRA_REPORT_TOPIC_AVRO;
DROP STREAM IF EXISTS RCRA_REPORT_TOPIC;
DROP STREAM IF EXISTS FDCE_REPORT_TOPIC;
DROP STREAM IF EXISTS FDCE_REPORT_TOPIC_AVRO;
DROP STREAM IF EXISTS KB_INDICATORS;
DROP STREAM IF EXISTS KB_INDICATORS_AVRO;
DROP STREAM IF EXISTS HP_CURRENTLY_CONNECTED_IPS;
DROP STREAM IF EXISTS HP_CURRENTLY_CONNECTED_IPS_FILTERED;
DROP STREAM IF EXISTS HP_CURRENTLY_CONNECTED_IPS_AVRO;
DROP STREAM IF EXISTS HP_INTERVAL_INFO;
DROP STREAM IF EXISTS HP_INTERVAL_INFO_FILTERED;
DROP STREAM IF EXISTS HP_INTERVAL_INFO_AVRO;
DROP STREAM IF EXISTS HP_MOST_USED;
DROP STREAM IF EXISTS HP_MOST_USED_FILTERED;
DROP STREAM IF EXISTS HP_MOST_USED_AVRO;
DROP STREAM IF EXISTS HP_SERVICE_COUNTERS;
DROP STREAM IF EXISTS HP_SERVICE_COUNTERS_FILTERED;
DROP STREAM IF EXISTS HP_SERVICE_COUNTERS_AVRO;
DROP STREAM IF EXISTS HP_STATIC_INFO;
DROP STREAM IF EXISTS HP_STATIC_INFO_FILTERED;
DROP STREAM IF EXISTS HP_STATIC_INFO_AVRO;
DROP STREAM IF EXISTS JDBC_SOURCE_AVRO;
DROP STREAM IF EXISTS dtm_alert;
DROP STREAM IF EXISTS dss_suggestions;
DROP STREAM IF EXISTS dss_suggestions_filtered;
DROP STREAM IF EXISTS AD_ALERTS;
DROP STREAM IF EXISTS AD_ALERTS_AVRO;

CREATE STREAM RCRA_REPORT_TOPIC (id INT KEY, "Threat Detected" VARCHAR, "Date" VARCHAR, "Asset" VARCHAR, "Risk Level" VARCHAR) WITH (KAFKA_TOPIC='rcra-report-topic', VALUE_FORMAT='JSON');
CREATE STREAM RCRA_REPORT_TOPIC_AVRO (id INT KEY, THREAT VARCHAR, TIMESTAMP VARCHAR, ASSET VARCHAR, RISK VARCHAR) WITH (KAFKA_TOPIC='RCRA_REPORT_TOPIC_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO RCRA_REPORT_TOPIC_AVRO SELECT id, "Threat Detected" AS THREAT, "Date" AS TIMESTAMP, "Asset" AS ASSET, "Risk Level" AS RISK FROM RCRA_REPORT_TOPIC;
CREATE STREAM FDCE_REPORT_TOPIC (id INT KEY, "Report Name" VARCHAR, "Date" VARCHAR, "Status" VARCHAR, "Last Edited" VARCHAR, "Description" VARCHAR) WITH (KAFKA_TOPIC='fdce-report-topic', VALUE_FORMAT='JSON');
CREATE STREAM FDCE_REPORT_TOPIC_AVRO (id INT KEY, REPORT VARCHAR, TIMESTAMP VARCHAR, STATUS VARCHAR, LASTEDITED VARCHAR, DESCRIPTION VARCHAR) WITH (KAFKA_TOPIC='FDCE_REPORT_TOPIC_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO FDCE_REPORT_TOPIC_AVRO SELECT id, "Report Name" AS REPORT, "Date" AS TIMESTAMP, "Status" AS STATUS, "Last Edited" AS LASTEDITED, "Description" AS DESCRIPTION FROM FDCE_REPORT_TOPIC;
CREATE STREAM KB_INDICATORS ("id" INT KEY, "articles" VARCHAR, "users" VARCHAR, "url" VARCHAR) WITH (KAFKA_TOPIC='kb-indicators', PARTITIONS=1, VALUE_FORMAT='JSON');
CREATE STREAM KB_INDICATORS_AVRO (id INT KEY, ARTICLES VARCHAR, USERS VARCHAR, URL VARCHAR) WITH (KAFKA_TOPIC='KB_INDICATORS_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO KB_INDICATORS_AVRO SELECT "id" as id, "articles" AS ARTICLES, "users" AS USERS, "url" AS URL FROM KB_INDICATORS;
CREATE STREAM HP_CURRENTLY_CONNECTED_IPS (id INT KEY, "currently_connected" ARRAY<VARCHAR>) WITH (KAFKA_TOPIC='hp-currently-connected-ips', PARTITIONS=12, VALUE_FORMAT='JSON');
CREATE STREAM HP_CURRENTLY_CONNECTED_IPS_FILTERED AS SELECT id, EXPLODE("currently_connected") AS currently_connected FROM HP_CURRENTLY_CONNECTED_IPS;
CREATE STREAM HP_CURRENTLY_CONNECTED_IPS_AVRO (id INT KEY, NAME VARCHAR, IP VARCHAR, SERVICE VARCHAR) WITH (KAFKA_TOPIC='HP_CURRENTLY_CONNECTED_IPS_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO HP_CURRENTLY_CONNECTED_IPS_AVRO SELECT id, EXTRACTJSONFIELD(currently_connected, '$.name') AS NAME, EXTRACTJSONFIELD(currently_connected, '$.ip') AS IP,  EXTRACTJSONFIELD(currently_connected, '$.service') AS SERVICE FROM HP_CURRENTLY_CONNECTED_IPS_FILTERED;
CREATE STREAM HP_INTERVAL_INFO (id INT KEY, "name" VARCHAR, "cpu_activity" VARCHAR, "memory_usage" VARCHAR, "upload" VARCHAR, "download" VARCHAR, "db_usage" VARCHAR) WITH (KAFKA_TOPIC='hp-interval-info', PARTITIONS=12, VALUE_FORMAT='JSON');
CREATE STREAM HP_INTERVAL_INFO_FILTERED AS SELECT id, "name" AS name, EXTRACTJSONFIELD("cpu_activity", '$.value') AS cpuactivityval, EXTRACTJSONFIELD("cpu_activity", '$.unit') AS cpuactivityunit, EXTRACTJSONFIELD("memory_usage", '$.value') AS memoryusageval, EXTRACTJSONFIELD("memory_usage", '$.unit') AS memoryusageunit, EXTRACTJSONFIELD("upload", '$.value') AS uploadval, EXTRACTJSONFIELD("upload", '$.unit') AS uploadunit, EXTRACTJSONFIELD("download", '$.value') AS downloadval, EXTRACTJSONFIELD("download", '$.unit') AS downloadunit, "db_usage" AS dbusage FROM HP_INTERVAL_INFO;
CREATE STREAM HP_INTERVAL_INFO_AVRO (id INT KEY, NAME VARCHAR, CPUACTIVITYVAL VARCHAR, CPUACTIVITYUNIT VARCHAR, MEMORYUSAGEVAL VARCHAR, MEMORYUSAGEUNIT VARCHAR, UPLOADVAL VARCHAR, UPLOADUNIT VARCHAR, DOWNLOADVAL VARCHAR, DOWNLOADUNIT VARCHAR, DBUSAGE VARCHAR) WITH (KAFKA_TOPIC='HP_INTERVAL_INFO_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO HP_INTERVAL_INFO_AVRO SELECT id, name AS NAME, cpuactivityval AS CPUACTIVITYVAL, cpuactivityunit AS CPUACTIVITYUNIT, memoryusageval AS MEMORYUSAGEVAL, memoryusageunit AS MEMORYUSAGEUNIT, uploadval AS UPLOADVAL, uploadunit AS UPLOADUNIT, downloadval AS DOWNLOADVAL, downloadunit AS DOWNLOADUNIT, dbusage AS DBUSAGE FROM HP_INTERVAL_INFO_FILTERED;
CREATE STREAM HP_MOST_USED (id INT KEY, "honey_name" VARCHAR, "honey_id" VARCHAR, "usernames" ARRAY<VARCHAR>, "passwords" ARRAY<VARCHAR>) WITH (KAFKA_TOPIC='hp-most-used', PARTITIONS=12, VALUE_FORMAT='JSON');
CREATE STREAM HP_MOST_USED_FILTERED AS SELECT id, "honey_name" AS honeyname, "honey_id" AS honeyid, EXPLODE("usernames") AS usernames, EXPLODE("passwords") AS passwords FROM HP_MOST_USED;
CREATE STREAM HP_MOST_USED_AVRO (id INT KEY, HONEYNAME VARCHAR, HONEYID VARCHAR, USERNAME VARCHAR, UTIMES VARCHAR, PASSWORD VARCHAR, PTIMES VARCHAR) WITH (KAFKA_TOPIC='HP_MOST_USED_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO HP_MOST_USED_AVRO SELECT id, honeyname AS HONEYNAME, honeyid AS HONEYID, EXTRACTJSONFIELD(usernames, '$.username') AS USERNAME, EXTRACTJSONFIELD(usernames, '$.times') AS UTIMES, EXTRACTJSONFIELD(passwords, '$.password') AS PASSWORD, EXTRACTJSONFIELD(passwords, '$.times') AS PTIMES FROM HP_MOST_USED_FILTERED;
CREATE STREAM HP_SERVICE_COUNTERS (id INT KEY, "name" VARCHAR, "stat" VARCHAR) WITH (KAFKA_TOPIC='hp-service-counters', PARTITIONS=12, VALUE_FORMAT='JSON');
CREATE STREAM HP_SERVICE_COUNTERS_FILTERED AS SELECT id, "name" AS name, "stat" AS stat FROM HP_SERVICE_COUNTERS;
CREATE STREAM HP_SERVICE_COUNTERS_AVRO (id INT KEY, NAME VARCHAR, STAT VARCHAR) WITH (KAFKA_TOPIC='HP_SERVICE_COUNTERS_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO HP_SERVICE_COUNTERS_AVRO SELECT id, name AS NAME, stat AS STAT FROM HP_SERVICE_COUNTERS_FILTERED;
CREATE STREAM HP_STATIC_INFO (id INT KEY, "name" VARCHAR, "isActive" VARCHAR, "active_services" VARCHAR, "flavor" VARCHAR, "general_info" VARCHAR) WITH (KAFKA_TOPIC='hp-static-info', PARTITIONS=12, VALUE_FORMAT='JSON');
CREATE STREAM HP_STATIC_INFO_FILTERED AS SELECT id, "name" AS name, "isActive" as isactive, EXTRACTJSONFIELD("active_services", '$.ssh') AS ssh, EXTRACTJSONFIELD("active_services", '$.ftp') AS ftp, EXTRACTJSONFIELD("active_services", '$.smtp') AS smtp, EXTRACTJSONFIELD("active_services", '$.http') AS http, "flavor" as flavor, "general_info" as generalinfo FROM HP_STATIC_INFO;
CREATE STREAM HP_STATIC_INFO_AVRO (id INT KEY, NAME VARCHAR, ISACTIVE VARCHAR, SSH VARCHAR, FTP VARCHAR, SMTP VARCHAR, HTTP VARCHAR, FLAVOR VARCHAR, GENERALINFO VARCHAR) WITH (KAFKA_TOPIC='HP_STATIC_INFO_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO HP_STATIC_INFO_AVRO SELECT id, name AS NAME, isactive AS ISACTIVE, ssh AS SSH, ftp AS FTP, smtp AS SMTP, http AS HTTP, flavor AS FLAVOR, generalinfo AS GENERALINFO FROM HP_STATIC_INFO_FILTERED;
CREATE STREAM JDBC_SOURCE_AVRO (id INT KEY, DESCRIPTION VARCHAR, TIMESTAMP VARCHAR, LOCATION VARCHAR, INDICATION VARCHAR, TOOL VARCHAR, STATUS VARCHAR, ACTION VARCHAR, DETAILS VARCHAR, SENT VARCHAR) WITH (KAFKA_TOPIC='JDBC_SOURCE_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
CREATE STREAM dtm_alert (id INT KEY, "objects" ARRAY<VARCHAR>, "flow_id" VARCHAR, "event_type" VARCHAR) WITH (KAFKA_TOPIC='dtm-alert', VALUE_FORMAT='JSON', PARTITIONS=1);
INSERT INTO JDBC_SOURCE_AVRO SELECT id, EXTRACTJSONFIELD("objects"[1], '$.details.alert.category') AS DESCRIPTION, EXTRACTJSONFIELD("objects"[1], '$.created') AS TIMESTAMP, EXTRACTJSONFIELD("objects"[1], '$.details.dest_geoip.country_name') AS LOCATION, '--' AS INDICATION, 'DTM' AS TOOL, 'OPEN' AS STATUS,  '--' AS ACTION, EXTRACTJSONFIELD("objects"[1], '$.details.alert') AS DETAILS, 'false' AS SENT FROM dtm_alert;
CREATE STREAM dss_suggestions (id INT KEY, "timestamp" VARCHAR, "event" VARCHAR, "destination_ip" VARCHAR, "suggestions" ARRAY<VARCHAR>) WITH (KAFKA_TOPIC='dss-suggestions', VALUE_FORMAT='JSON', PARTITIONS=1);
CREATE STREAM dss_suggestions_filtered AS SELECT id, "timestamp" AS timestamp, "event" AS event, "destination_ip" AS destinationIP, EXPLODE("suggestions") AS suggestion FROM dss_suggestions;
INSERT INTO JDBC_SOURCE_AVRO SELECT id, event AS DESCRIPTION, timestamp AS TIMESTAMP, '--' AS LOCATION, destinationIP AS INDICATION, 'DSS' AS TOOL, 'OPEN' AS STATUS,  EXTRACTJSONFIELD(suggestion, '$.suggestion') AS ACTION, EXTRACTJSONFIELD(suggestion, '$.risk_reduction_level') AS DETAILS, 'false' AS SENT FROM dss_suggestions_filtered;
CREATE STREAM AD_ALERTS (id INT KEY, "objects" ARRAY<VARCHAR>) WITH (KAFKA_TOPIC='ad-alerts', PARTITIONS=12, VALUE_FORMAT='JSON');
CREATE STREAM AD_ALERTS_AVRO (id INT KEY, TOTALFLOWS VARCHAR, PROTOCOLFLOWID VARCHAR, PROTOCOLFLOWDETECTEDPROTOCOL VARCHAR, PROTOCOLFLOWLOWERPORT VARCHAR, PROTOCOLFLOWUPPERPORT VARCHAR, PROTOCOLFLOWUPPERIP VARCHAR, PROTOCOLFLOWLOWERIP VARCHAR, PROTOCOLFLOWIPPROTOCOL VARCHAR, PROTOCOLFLOWFLOWDURATION VARCHAR, PROTOCOLFLOWBYTES VARCHAR, PROTOCOLFLOWPACKETS VARCHAR, PROTOCOLFLOWPACKETSWITHOUTPAYLOAD VARCHAR, PROTOCOLFLOWAVGPACKETSIZE VARCHAR, PROTOCOLFLOWMINPACKETSIZE VARCHAR, PROTOCOLFLOWMAXPACKETSIZE VARCHAR, PROTOCOLFLOWAVGINTERTIME VARCHAR, PROTOCOLFLOWPACKETSIZE0 VARCHAR, PROTOCOLFLOWINNERTIME0 VARCHAR, PROTOCOLFLOWPACKETSIZE1 VARCHAR, PROTOCOLFLOWINNERTIME1 VARCHAR, PROTOCOLFLOWPACKETSIZE2 VARCHAR, PROTOCOLFLOWINNERTIME2 VARCHAR, PROTOCOLFLOWPACKETSIZE3 VARCHAR, PROTOCOLFLOWINNERTIME3 VARCHAR, PROTOCOLFLOWPACKETSIZE4 VARCHAR, PROTOCOLFLOWINNERTIME4 VARCHAR, PROTOCOLFLOWHOSTNAME VARCHAR, PROTOCOLFLOWDNATYPE VARCHAR, PROTOCOLFLOWTIMESTAMP2 VARCHAR, PROTOCOLFLOWMALWARE VARCHAR, PROTOCOLFLOWFLAGS VARCHAR, TEXT VARCHAR, TITLE VARCHAR, FLOWID VARCHAR, COORDS VARCHAR, USERNAME VARCHAR, TIMESTAMP VARCHAR, ALGORITHMTYPE VARCHAR, ALGORITHMHOSTNAME VARCHAR, ALGORITHMBYTESUP VARCHAR, ALGORITHMBYTESDOWN VARCHAR, ALGORITHMNUMBERPKTS VARCHAR, ALGORITHMCONNECTIONS VARCHAR, ALGORITHMSTRINGFLOWS VARCHAR) WITH (KAFKA_TOPIC='AD_ALERTS_AVRO', PARTITIONS=1, VALUE_FORMAT='AVRO');
INSERT INTO AD_ALERTS_AVRO SELECT id, EXTRACTJSONFIELD("objects"[2], '$.details.totalFlows') AS TOTALFLOWS, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.id') AS PROTOCOLFLOWID, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.detectedProtocol') AS PROTOCOLFLOWDETECTEDPROTOCOL, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.lowerPort') AS PROTOCOLFLOWLOWERPORT, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.upperPort') AS PROTOCOLFLOWUPPERPORT, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.upperIp') AS PROTOCOLFLOWUPPERIP, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.lowerIp') AS PROTOCOLFLOWLOWERIP, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.ipProtocol') AS PROTOCOLFLOWIPPROTOCOL, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.flowDuration') AS PROTOCOLFLOWFLOWDURATION, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.bytes') AS PROTOCOLFLOWBYTES, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.packets') AS PROTOCOLFLOWPACKETS, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.packetsWithoutPayload') AS PROTOCOLFLOWPACKETSWITHOUTPAYLOAD, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.avgPacketSize') AS PROTOCOLFLOWAVGPACKETSIZE, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.minPacketSize') AS PROTOCOLFLOWMINPACKETSIZE, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.maxPacketSize') AS PROTOCOLFLOWMAXPACKETSIZE, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.avgInterTime') AS PROTOCOLFLOWAVGINTERTIME, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.packetSize0') AS PROTOCOLFLOWPACKETSIZE0, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.interTime0') AS PROTOCOLFLOWINNERTIME0, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.packetSize1') AS PROTOCOLFLOWPACKETSIZE1, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.innerTime1') AS PROTOCOLFLOWINNERTIME1, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.packetSize2') AS PROTOCOLFLOWPACKETSIZE2, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.innerTime2') AS PROTOCOLFLOWINNERTIME2, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.packetSize3') AS PROTOCOLFLOWPACKETSIZE3, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.innerTime3') AS PROTOCOLFLOWINNERTIME3, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.packetSize4') AS PROTOCOLFLOWPACKETSIZE4, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.innerTime4') AS PROTOCOLFLOWINNERTIME4, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.hostname') AS PROTOCOLFLOWHOSTNAME, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.dnaType') AS PROTOCOLFLOWDNATYPE, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.timeStamp2') AS PROTOCOLFLOWTIMESTAMP2, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.malware') AS PROTOCOLFLOWMALWARE, EXTRACTJSONFIELD("objects"[2], '$.details.protocolFlow.flags') AS PROTOCOLFLOWFLAGS, EXTRACTJSONFIELD("objects"[2], '$.details.text') AS TEXT, EXTRACTJSONFIELD("objects"[2], '$.details.title') AS TITLE, EXTRACTJSONFIELD("objects"[2], '$.details.flowId') AS FLOWID, EXTRACTJSONFIELD("objects"[2], '$.details.coords') AS COORDS, EXTRACTJSONFIELD("objects"[2], '$.details.username') AS USERNAME, EXTRACTJSONFIELD("objects"[2], '$.details.timestamp') AS TIMESTAMP, EXTRACTJSONFIELD("objects"[2], '$.details.algorithm.type') AS ALGORITHMTYPE, EXTRACTJSONFIELD("objects"[2], '$.details.algorithm.hostname') AS ALGORITHMHOSTNAME, EXTRACTJSONFIELD("objects"[2], '$.details.algorithm.bytesUp') AS ALGORITHMBYTESUP, EXTRACTJSONFIELD("objects"[2], '$.details.algorithm.bytesDown') AS ALGORITHMBYTESDOWN, EXTRACTJSONFIELD("objects"[2], '$.details.algorithm.numerPkts') AS ALGORITHMNUMBERPKTS, EXTRACTJSONFIELD("objects"[2], '$.details.algorithm.connections') AS ALGORITHMCONNECTIONS, EXTRACTJSONFIELD("objects"[2], '$.details.algorithm.stringFlows') AS ALGORITHMSTRINGFLOWS FROM AD_ALERTS;
